name: Infra Deploy

on:
  workflow_dispatch:
    inputs:
      terraform_dir:
        description: "Terraform directory"
        required: false
        default: "terraform"
      wait_for_completion:
        description: "Wait for the Terraform Cloud run to finish"
        required: false
        default: "true"

permissions:
  contents: read

jobs:
  terraform-apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Trigger Terraform Cloud run
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
          TFC_ORG: ${{ secrets.TFC_ORG }}
          TFC_WORKSPACE: ${{ secrets.TFC_WORKSPACE }}
        run: |
          set -euo pipefail

          if [[ -z "${TFC_TOKEN}" || -z "${TFC_ORG}" || -z "${TFC_WORKSPACE}" ]]; then
            echo "Missing TFC_TOKEN, TFC_ORG, or TFC_WORKSPACE. Configure secrets to enable deploy."
            exit 1
          fi

          WORKSPACE_JSON=$(curl -sS \
            -H "Authorization: Bearer ${TFC_TOKEN}" \
            -H "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/organizations/${TFC_ORG}/workspaces/${TFC_WORKSPACE}")

          WORKSPACE_ID=$(python3 - <<'PY'
import json,sys
data=json.load(sys.stdin)
print(data["data"]["id"])
PY
          <<<"${WORKSPACE_JSON}")

          RUN_PAYLOAD=$(cat <<EOF
{
  "data": {
    "attributes": {
      "message": "Triggered by GitHub Actions: infra-deploy",
      "is-destroy": false
    },
    "type": "runs",
    "relationships": {
      "workspace": {
        "data": {
          "type": "workspaces",
          "id": "${WORKSPACE_ID}"
        }
      }
    }
  }
}
EOF
          )

          RUN_JSON=$(curl -sS \
            -H "Authorization: Bearer ${TFC_TOKEN}" \
            -H "Content-Type: application/vnd.api+json" \
            -d "${RUN_PAYLOAD}" \
            "https://app.terraform.io/api/v2/runs")

          RUN_ID=$(python3 - <<'PY'
import json,sys
data=json.load(sys.stdin)
print(data["data"]["id"])
PY
          <<<"${RUN_JSON}")

          echo "run_id=${RUN_ID}" >> "$GITHUB_OUTPUT"
        id: tfc

      - name: Wait for Terraform Cloud run
        if: ${{ inputs.wait_for_completion == 'true' }}
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.tfc.outputs.run_id }}"

          while true; do
            RUN_STATUS_JSON=$(curl -sS \
              -H "Authorization: Bearer ${TFC_TOKEN}" \
              -H "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/runs/${RUN_ID}")

            STATUS=$(python3 - <<'PY'
import json,sys
data=json.load(sys.stdin)
print(data["data"]["attributes"]["status"])
PY
            <<<"${RUN_STATUS_JSON}")

            echo "Run status: ${STATUS}"

            case "${STATUS}" in
              applied|planned_and_finished)
                exit 0
                ;;
              errored|canceled)
                exit 1
                ;;
            esac

            sleep 10
          done
