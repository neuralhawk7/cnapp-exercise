name: Security scans (informational)

on:
  pull_request:
  push:
    branches: [ main, 'feature/**', '**' ]

jobs:
  trivy:
    name: Trivy scans (non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker (for image scans if needed)
        uses: docker/setup-buildx-action@v2

      - name: Trivy IaC scan (SARIF)
        uses: aquasecurity/trivy-action@v0.9.0
        with:
          scan-type: iac
          format: sarif
          output: trivy-iac.sarif

      - name: Trivy filesystem scan (SARIF)
        uses: aquasecurity/trivy-action@v0.9.0
        with:
          scan-type: fs
          format: sarif
          output: trivy-fs.sarif

      - name: Check for Dockerfile
        id: dockerfile
        run: |
          found=false
          if [ -f Dockerfile ] || [ -f app/Dockerfile ] || [ -f */Dockerfile ]; then found=true; fi
          echo "found=$found" >> $GITHUB_OUTPUT

      - name: Build Docker image (if Dockerfile present)
        if: steps.dockerfile.outputs.found == 'true'
        uses: docker/build-push-action@v4
        with:
          push: false
          load: true
          tags: ${{ github.repository }}:${{ github.sha }}
          file: app/Dockerfile

      - name: Push image to GHCR (optional, non-blocking)
        if: steps.dockerfile.outputs.found == 'true'
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: ${{ github.repository }}:${{ github.sha }}
        run: |
          echo "Attempting GHCR push (will skip if no credentials)"
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          GHCR_TAG_MAIN=ghcr.io/$GITHUB_REPOSITORY:$GITHUB_SHA
          GHCR_TAG_SHORT=ghcr.io/$GITHUB_REPOSITORY:$SHORT_SHA
          GHCR_TAG_LATEST=ghcr.io/$GITHUB_REPOSITORY:latest
          if [ -n "$GHCR_PAT" ]; then
            echo "$GHCR_PAT" | docker login ghcr.io -u ${{ github.actor }} --password-stdin || true
          else
            echo "No GHCR_PAT found; trying GITHUB_TOKEN (may not have write permission)" && echo "$GITHUB_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin || true
          fi
          docker tag "$IMAGE_TAG" "$GHCR_TAG_MAIN" || true
          docker tag "$IMAGE_TAG" "$GHCR_TAG_SHORT" || true
          docker tag "$IMAGE_TAG" "$GHCR_TAG_LATEST" || true
          docker push "$GHCR_TAG_MAIN" || true
          docker push "$GHCR_TAG_SHORT" || true
          docker push "$GHCR_TAG_LATEST" || true

      - name: Push image to ECR (optional, non-blocking)
        if: steps.dockerfile.outputs.found == 'true'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.repository }}:${{ github.sha }}
        run: |
          echo "Attempting ECR push (will skip if AWS creds / ECR info missing)"
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$ECR_REGISTRY" ] || [ -z "$ECR_REPOSITORY" ]; then
            echo "Missing ECR vars; skipping ECR push" && exit 0
          fi
          # Configure AWS CLI
          pip install awscli --upgrade --user || true
          export PATH="$HOME/.local/bin:$PATH"
          # Create ECR repository if it doesn't exist (non-blocking)
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" --region "$AWS_REGION" >/dev/null 2>&1 || (
            echo "ECR repository not found â€” creating $ECR_REPOSITORY" && aws ecr create-repository --repository-name "$ECR_REPOSITORY" --region "$AWS_REGION" || true
          )
          aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "$ECR_REGISTRY" || true
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          ECR_TAG_FULL="$ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA"
          ECR_TAG_SHORT="$ECR_REGISTRY/$ECR_REPOSITORY:$SHORT_SHA"
          ECR_TAG_LATEST="$ECR_REGISTRY/$ECR_REPOSITORY:latest"
          docker tag "$IMAGE_TAG" "$ECR_TAG_FULL" || true
          docker tag "$IMAGE_TAG" "$ECR_TAG_SHORT" || true
          docker tag "$IMAGE_TAG" "$ECR_TAG_LATEST" || true
          docker push "$ECR_TAG_FULL" || true
          docker push "$ECR_TAG_SHORT" || true
          docker push "$ECR_TAG_LATEST" || true

      - name: Trivy image scan (SARIF) (skipped if no Dockerfile)
        if: steps.dockerfile.outputs.found == 'true'
        uses: aquasecurity/trivy-action@v0.9.0
        with:
          scan-type: image
          image-ref: ${{ github.repository }}:${{ github.sha }}
          format: sarif
          output: trivy-image.sarif

      - name: Trivy image scan (JSON for counts)
        if: steps.dockerfile.outputs.found == 'true'
        uses: aquasecurity/trivy-action@v0.9.0
        with:
          scan-type: image
          image-ref: ${{ github.repository }}:${{ github.sha }}
          format: json
          output: trivy-image.json

      - name: Install jq (for parsing) 
        if: steps.dockerfile.outputs.found == 'true'
        run: sudo apt-get update && sudo apt-get install -y jq || true

      - name: Count HIGH/CRITICAL CVEs
        id: cve_counts
        if: steps.dockerfile.outputs.found == 'true'
        run: |
          high=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' trivy-image.json 2>/dev/null || echo 0)
          echo "high_count=$high" >> $GITHUB_OUTPUT
          echo "found_high=$([ $high -gt 0 ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Post PR comment with CVE summary (informational)
        if: ${{ github.event_name == 'pull_request' && steps.cve_counts.outputs.found_high == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          body="Trivy image scan found ${{ steps.cve_counts.outputs.high_count }} HIGH/CRITICAL CVE(s) in the built image. This is informational only. See `trivy-image.json` and `trivy-image.sarif` in the workflow artifacts."
          curl -s -X POST -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$GITHUB_REPOSITORY/issues/$PR_NUM/comments \
            -d "$(jq -nc --arg b "$body" '{body:$b}')" || true

      - name: Add 'security/high-cve' label to PR (informational)
        if: ${{ github.event_name == 'pull_request' && steps.cve_counts.outputs.found_high == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          curl -s -X POST -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$GITHUB_REPOSITORY/issues/$PR_NUM/labels \
            -d '{"labels":["security/high-cve"]}' || true

      - name: Upload Trivy SARIF artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sarif
          path: |
            trivy-iac.sarif
            trivy-fs.sarif
            trivy-image.sarif
            trivy-image.json

      - name: Upload Trivy SARIF to Code Scanning (optional)
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-iac.sarif

  legitify:
    name: Legitify scan (non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install requirements (best-effort)
        run: |
          set -e
          # Try to download the legitify binary from releases (best-effort; failure is non-blocking)
          curl -sL "https://github.com/legitify/legitify/releases/latest/download/legitify_linux_amd64.tar.gz" -o legitify.tar.gz || true
          tar -xzf legitify.tar.gz || true
          chmod +x ./legitify || true
          ./legitify --version || true

      - name: Run Legitify scan (best-effort)
        env:
          LEGITIFY_TOKEN: ${{ secrets.LEGITIFY_TOKEN }}
        run: |
          if [ -x ./legitify ]; then
            ./legitify scan --github-token "$LEGITIFY_TOKEN" --format sarif --output legitify.sarif || true
          else
            echo "Legitify CLI not installed; skipping scan"
          fi

      - name: Upload Legitify SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: legitify-sarif
          path: legitify.sarif

      - name: Upload Legitify SARIF to Code Scanning (optional)
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: legitify.sarif
