name: Security Scans

on:
  schedule:
    - cron: "0 4 * * 1"
  workflow_dispatch:
    inputs:
      ghcr_image:
        description: "GHCR image to scan"
        required: false
        default: ""
      ecr_repo:
        description: "ECR repo name"
        required: false
        default: "cnapp-demo/express-hello"
      aws_region:
        description: "AWS region"
        required: false
        default: "us-east-1"

permissions:
  contents: read
  packages: read
  security-events: write
  id-token: write

jobs:
  trivy-ecr:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region }}
      ECR_REPO: ${{ inputs.ecr_repo }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
    steps:
      - name: Configure AWS credentials
        if: ${{ env.AWS_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Resolve ECR image
        id: image
        if: ${{ env.AWS_ROLE_ARN != '' }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "image_uri=${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest" >> "$GITHUB_OUTPUT"
      - name: Trivy scan ECR image
        if: ${{ env.AWS_ROLE_ARN != '' }}
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          image-ref: ${{ steps.image.outputs.image_uri }}
          format: sarif
          output: trivy-ecr.sarif
      - name: Upload ECR SARIF
        if: ${{ env.AWS_ROLE_ARN != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-ecr.sarif
